name: Test Action

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ '*' ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        # Fetch enough history for proper diff comparison
        fetch-depth: 0
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: npm install
    
    - name: Test the action
      uses: ./
      id: review
      with:
        anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
    
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      env:
        THEMES: ${{ steps.review.outputs.themes }}
        SUMMARY: ${{ steps.review.outputs.summary }}
      with:
        script: |
          const themes = process.env.THEMES || 'No themes found';
          const summary = process.env.SUMMARY || 'No summary available';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## ðŸ¤– AI Code Review Results
            
            **Themes:** ${themes}
            
            **Summary:** ${summary}
            
            ---
            *Generated by AI Code Review Action*`
          })